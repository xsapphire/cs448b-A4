<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Loading GeoJSON data and generating SVG paths</title>
		<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
		<script type="text/javascript" src="worldmap.js"></script>
		<style type="text/css">
			/* No style rules here yet */		
		</style>
	</head>
	<body>
		<script type="text/javascript">
			//Width and height
			var w = 1000;
			var h = 1000;
							   
			var projection = d3.geoMercator()
										.scale((w - 3) / (2 * Math.PI))
										.translate([w / 2, h / 2]);

			var path = d3.geoPath().projection(projection);

			
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
			//Load in GeoJSON data
			var data = countries_data;
			//console.log(data);
			var billionCountryMap = {}; // In form of {countryCode: [person 1, person 2] , countryCode: [person 1, ...]}
			
			/* The data range is 1 to 903 (Only usa 903, all the rest <= 160)
			 * Using six color patch: Lightest #dcecc9, #b3ddcc, #8acdce, #62bed2, #46aace, #151e5e darkest 
			 * Use the darkest for usa, and distribute the rest 5 colors to the range [1,160]. Each color span 32 numbers.
			 */
			function color(billionairArray){
				var billionairCount = billionairArray.length;
				if (billionairCount > 0 && billionairCount <= 32){
					return "#dcecc9";
				} else if (billionairCount > 32 && billionairCount <= 64){
					return "#b3ddcc";
				} else if (billionairCount > 64 && billionairCount <= 96){
					return "#8acdce";
				} else if (billionairCount > 96 && billionairCount <= 128){
					return "#62bed2";
				} else if (billionairCount > 128 && billionairCount <= 160){
					return "#46aace";
				} else {
					return "#151e5e";
				}
			}
			
			d3.csv("billionaireDataCropped.csv", function (csv){
				//console.log(csv);
				
				csv.forEach(function(entry){
					var thisEntryCountry = entry.countrycode;
					if (Object.keys(billionCountryMap).indexOf(thisEntryCountry) === -1) {
						// Add a new country:billionaire array pair
						billionCountryMap[thisEntryCountry] = [entry];
					} else {
						billionCountryMap[thisEntryCountry].push(entry);
					}
					
				});
				
				//console.log(billionCountryMap);
				// Draw map
				svg.selectAll("path")
				   .data(data.features)
				   .enter()
				   .append("path")
				   .attr("d", path)
				   .style("fill", function(d) {
						//console.log(d);
						var countryId = d.id;

						if (Object.keys(billionCountryMap).indexOf(countryId) !== -1) {
							//console.log(color(billionCountryMap[countryId]));
							return color(billionCountryMap[countryId]);
						} else {
								return "#ccc";
						}
				   })
					.append("svg:title")
					.text(function(d){
						var billionairNumber;
						var countryId = d.id;

						if (Object.keys(billionCountryMap).indexOf(countryId) !== -1) {
							billionairNumber = billionCountryMap[countryId].length;
						} else {
							billionairNumber = 0;
						}
						
						return d.properties.name + ": " + billionairNumber + " billionaires";
					});
			});
			
		</script>
	</body>
</html>

